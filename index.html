<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>To-Do Kolaboratif (Realtime)</title>
  <meta name="description" content="Shared to-do list - realtime dengan Firebase Firestore (no login)"/>
  <style>
    :root{ --bg:#07101a; --card:#0b1220; --accent:#6ee7b7; --muted:#94a3b8; --glass: rgba(255,255,255,0.03); --radius:12px;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; color-scheme: dark;}
    *{box-sizing:border-box}
    body{margin:0; min-height:100vh; background:linear-gradient(180deg,#07101a,#071a2a); color:#e6eef6; display:flex; align-items:center; justify-content:center; padding:24px}
    .wrap{width:100%; max-width:980px}
    .card{background:var(--card); padding:18px; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    header{display:flex; gap:12px; align-items:center; margin-bottom:16px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:flex;align-items:center;justify-content:center;color:#042024;font-weight:700}
    h1{margin:0;font-size:18px}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .grid{display:grid; grid-template-columns:1fr 320px; gap:18px}
    input, select, textarea, button{font-family:inherit}
    input[type=text], input[type=date], select, textarea{background:var(--glass); border:1px solid rgba(255,255,255,0.04); padding:8px 10px; color:inherit; border-radius:8px; width:100%; outline:none}
    button{background:linear-gradient(90deg,var(--accent),#60a5fa); color:#042024; border:none; padding:8px 10px; border-radius:10px; cursor:pointer}
    .btn-ghost{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted)}
    .controls{display:flex; gap:8px; align-items:center; margin-bottom:12px}
    .list{max-height:60vh; overflow:auto}
    .task{display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; margin-bottom:8px; border:1px solid rgba(255,255,255,0.02); background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .task h3{margin:0;font-size:15px}
    .meta{font-size:12px;color:var(--muted); margin-top:6px}
    .actions{display:flex; gap:8px}
    .completed h3{ text-decoration:line-through; opacity:0.6 }
    footer{margin-top:12px; color:var(--muted); font-size:13px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} .logo{width:48px;height:48px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">TD</div>
      <div>
        <h1>To-Do Bersama (Realtime)</h1>
        <p class="lead">Semua user berbagi 1 daftar yang sama. Tanpa login â€” realtime via Firebase Firestore.</p>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <form id="taskForm">
          <div style="display:flex; gap:8px; margin-bottom:8px">
            <input id="title" type="text" placeholder="Tulis tugas..." required>
            <select id="priority"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select>
          </div>
          <div style="display:flex; gap:8px; margin-bottom:8px">
            <input id="due" type="date">
            <input id="tags" type="text" placeholder="Tag (pisah koma)">
          </div>
          <textarea id="note" rows="2" placeholder="Catatan (opsional)" style="margin-bottom:8px"></textarea>
          <div style="display:flex; gap:8px">
            <button id="saveBtn" type="submit">Tambah</button>
            <button id="clearAll" type="button" class="btn-ghost">Hapus Semua</button>
          </div>
        </form>

        <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:12px 0">

        <div class="controls">
          <input id="search" placeholder="Cari tugas..." style="flex:1">
          <select id="filter"><option value="all">Semua</option><option value="active">Aktif</option><option value="done">Selesai</option></select>
          <select id="sort"><option value="created_desc">Terbaru</option><option value="created_asc">Terlama</option><option value="due">Jatuh Tempo</option><option value="priority">Prioritas</option></select>
        </div>

        <div class="list" id="taskList"></div>
        <footer id="statusFooter">Mode: <strong id="modeLabel">Local (offline)</strong></footer>
      </section>

      <aside class="card">
        <h3 style="margin-top:0">Kontrol & Ringkasan</h3>
        <div style="margin:10px 0;color:var(--muted)">
          <div>Total: <span id="countTotal">0</span></div>
          <div>Aktif: <span id="countActive">0</span></div>
          <div>Selesai: <span id="countDone">0</span></div>
        </div>

        <hr style="border:none;height:1px;background:rgba(255,255,255,0.03);margin:12px 0">
        <h4>Firebase Sync</h4>
        <p style="color:var(--muted);font-size:13px">Klik untuk mengaktifkan sinkronisasi realtime ke Firestore (shared list). Pastikan Firestore telah dibuat di console dan project config sudah diisi.</p>
        <button id="syncBtn" class="btn-ghost">Aktifkan Firebase</button>
        <div style="margin-top:10px;color:var(--muted);font-size:12px">Firestore collection: <code>todos</code></div>
        <small style="display:block;margin-top:12px;color:var(--muted)">Versi realtime â€¢ ChatGPT</small>
      </aside>
    </div>
  </div>

  <!-- REPLACE FIREBASE CONFIG BELOW with your project's config (Project settings â†’ SDK setup) -->
  <script type="module">
    // Import modular Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // ====== PASTE FIREBASE CONFIG HERE ======
    // Replace the values below with your Firebase project's config
    const FIREBASE_CONFIG = {
      apiKey: "PASTE_API_KEY",
      authDomain: "PASTE_AUTH_DOMAIN",
      projectId: "PASTE_PROJECT_ID",
      storageBucket: "PASTE_STORAGE_BUCKET",
      messagingSenderId: "PASTE_MSG_ID",
      appId: "PASTE_APP_ID"
    };
    // =========================================

    // LocalStorage fallback key
    const STORAGE_KEY = 'todo_shared_v1';
    let tasks = [];         // local array that mirrors server when syncing
    let unsubscribe = null; // firestore listener unsub function
    let synced = false;     // whether realtime sync is active

    // Initialize local state from storage
    function loadLocal() {
      try {
        tasks = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      } catch (e) { tasks = []; }
    }
    function saveLocal() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
      render();
    }

    // Utility: create visible element for a task and attach actions
    function createTaskElement(t) {
      const el = document.createElement('div');
      el.className = 'task' + (t.done ? ' completed' : '');
      const left = document.createElement('div'); left.className = 'left';
      const h = document.createElement('h3'); h.textContent = t.title;
      const meta = document.createElement('div'); meta.className = 'meta';
      meta.textContent = `${t.due ? 'ðŸ“… '+t.due+' â€¢ ' : ''}${t.priority}${t.tags ? ' â€¢ '+t.tags : ''}`;
      left.appendChild(h); left.appendChild(meta);

      const actions = document.createElement('div'); actions.className='actions';
      const doneBtn = document.createElement('button'); doneBtn.className='btn-ghost'; doneBtn.textContent = t.done ? 'Buka' : 'Selesai';
      doneBtn.addEventListener('click', () => toggleDone(t));
      const delBtn = document.createElement('button'); delBtn.className='btn-ghost'; delBtn.textContent = 'Hapus';
      delBtn.addEventListener('click', () => removeTask(t));
      actions.appendChild(doneBtn); actions.appendChild(delBtn);

      el.appendChild(left); el.appendChild(actions);
      return el;
    }

    // Render list based on tasks[] and filters
    function render() {
      const listEl = document.getElementById('taskList');
      listEl.innerHTML = '';
      const q = document.getElementById('search').value.trim().toLowerCase();
      const filter = document.getElementById('filter').value;
      const sort = document.getElementById('sort').value;

      let items = tasks.slice();

      if (q) items = items.filter(t => (t.title||'').toLowerCase().includes(q) || (t.tags||'').toLowerCase().includes(q) || (t.note||'').toLowerCase().includes(q));
      if (filter === 'active') items = items.filter(t => !t.done);
      if (filter === 'done') items = items.filter(t => t.done);

      if (sort === 'created_desc') items.sort((a,b) => (b.created||0)-(a.created||0));
      if (sort === 'created_asc') items.sort((a,b) => (a.created||0)-(b.created||0));
      if (sort === 'due') items.sort((a,b) => (a.due||'9999') > (b.due||'9999') ? 1 : -1);
      if (sort === 'priority') { const order = { high:0, medium:1, low:2 }; items.sort((a,b)=> (order[a.priority]||1) - (order[b.priority]||1)); }

      for (const t of items) listEl.appendChild(createTaskElement(t));
      document.getElementById('countTotal').textContent = tasks.length;
      document.getElementById('countDone').textContent = tasks.filter(x=>x.done).length;
      document.getElementById('countActive').textContent = tasks.filter(x=>!x.done).length;
    }

    // LOCAL CRUD (used when not synced)
    function addLocalTask(data) {
      const t = {
        id: 't'+Date.now()+'-'+Math.random().toString(36).slice(2,6),
        title: data.title,
        note: data.note||'',
        tags: data.tags||'',
        priority: data.priority||'medium',
        due: data.due||'',
        done: false,
        created: Date.now()
      };
      tasks.push(t); saveLocal();
    }
    function toggleDoneLocal(id) {
      const t = tasks.find(x=>x.id===id); if(!t) return;
      t.done = !t.done; saveLocal();
    }
    function removeLocal(id) { tasks = tasks.filter(x=>x.id!==id); saveLocal(); }
    function clearAllLocal() { if(!confirm('Hapus semua tugas lokal?')) return; tasks=[]; saveLocal(); }

    // FIRESTORE HANDLERS (used when synced)
    let db = null;
    function toFirestoreAdd(data) { return addDoc(collection(db, 'todos'), data); }
    function toFirestoreUpdate(docRef, fields) { return updateDoc(docRef, fields); }
    function toFirestoreDelete(docRef) { return deleteDoc(docRef); }

    // Toggle done helper (decides local vs firestore)
    async function toggleDone(task) {
      if (synced) {
        try {
          const docRef = doc(db, 'todos', task._id);
          // if snapshot uses field 'done'
          await updateDoc(docRef, { done: !task.done });
        } catch (err) { console.error('Update failed', err); }
      } else {
        toggleDoneLocal(task.id);
      }
    }

    // Remove helper
    async function removeTask(task) {
      if (synced) {
        try {
          const docRef = doc(db, 'todos', task._id);
          await deleteDoc(docRef);
        } catch (err) { console.error('Delete failed', err); }
      } else {
        removeLocal(task.id);
      }
    }

    // When sync enabled: push local->server if server empty, then subscribe to server updates
    async function enableSync() {
      if (synced) return;
      // init firebase
      try {
        const app = initializeApp(FIREBASE_CONFIG);
        db = getFirestore(app);
      } catch (e) {
        alert('Gagal inisialisasi Firebase. Periksa konfigurasi.');
        console.error(e);
        return;
      }

      // check server collection
      const todosColl = collection(db, 'todos');
      const q = query(todosColl, orderBy('created','desc'));
      const snapshotNow = await getDocs(q);

      if (snapshotNow.empty && tasks.length>0) {
        // push local tasks to server
        for (const t of tasks) {
          // remove local-only id before adding
          const { id, ...rest } = t;
          try { await addDoc(todosColl, rest); } catch(e){ console.error(e); }
        }
      } else {
        // load server tasks into local
        tasks = snapshotNow.docs.map(d => {
          const data = d.data();
          return {
            _id: d.id,
            title: data.title||data.text||'',
            note: data.note||'',
            tags: data.tags||'',
            priority: data.priority||'medium',
            due: data.due||'',
            done: data.done||false,
            created: data.created || (data.createdAt? data.createdAt.toMillis(): Date.now())
          };
        });
        saveLocal();
      }

      // start realtime listener
      unsubscribe = onSnapshot(todosColl, snap => {
        // map docs to local tasks (use _id to link to doc id)
        tasks = snap.docs.map(d => {
          const data = d.data();
          return {
            _id: d.id,
            title: data.title||data.text||'',
            note: data.note||'',
            tags: data.tags||'',
            priority: data.priority||'medium',
            due: data.due||'',
            done: data.done||false,
            created: data.created || (data.createdAt? data.createdAt.toMillis(): Date.now())
          };
        });
        saveLocal(); // will call render
      }, err => {
        console.error('Realtime listener failed', err);
      });

      synced = true;
      document.getElementById('modeLabel').textContent = 'Realtime (Firebase)';
      document.getElementById('syncBtn').textContent = 'Sinkron Aktif';
      document.getElementById('syncBtn').disabled = true;
      alert('Sinkronisasi Firebase aktif â€” semua user sekarang berbagi satu daftar (collection: todos).');
    }

    // Event bindings
    loadLocal(); render();

    document.getElementById('taskForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = {
        title: document.getElementById('title').value.trim(),
        note: document.getElementById('note').value.trim(),
        tags: document.getElementById('tags').value.trim(),
        priority: document.getElementById('priority').value,
        due: document.getElementById('due').value,
        created: Date.now(),
        done: false
      };
      if (!data.title) return alert('Tulis tugas terlebih dahulu');

      if (synced) {
        try {
          await addDoc(collection(db, 'todos'), data);
        } catch (err) { console.error('Add fail', err); alert('Gagal tambah ke Firestore'); }
      } else {
        addLocalTask(data);
      }
      e.target.reset();
    });

    document.getElementById('syncBtn').addEventListener('click', () => {
      if (confirm('Aktifkan sinkronisasi realtime ke Firebase? (Pastikan Firestore sudah aktif di Firebase Console)')) {
        enableSync().catch(err => console.error(err));
      }
    });

    document.getElementById('clearAll').addEventListener('click', async () => {
      if (!confirm('Hapus semua tugas? (Ini akan menghapus lokal. Jika sudah sinkron, hapus server manual)')) return;
      if (synced) {
        // delete all docs in collection (caution: not efficient for many docs)
        const col = collection(db, 'todos');
        const snap = await getDocs(col);
        for (const d of snap.docs) {
          try { await deleteDoc(doc(db, 'todos', d.id)); } catch(e){ console.error(e); }
        }
      } else {
        clearAllLocal();
      }
    });

    // search / filter / sort bindings
    ['search','filter','sort'].forEach(id => document.getElementById(id).addEventListener('input', render));

    // ensure render updates when local changes happen (we call saveLocal in handlers)
    // expose nothing to global; all done via listeners and realtime snapshot

  </script>
</body>
</html>
